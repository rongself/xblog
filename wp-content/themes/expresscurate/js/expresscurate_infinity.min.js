(function(e){"use strict";Date.now=Date.now||function(){return+(new Date)};e.expresscurate=function(t){function u(){var t;i.onChangePage(function(e,t,r){if(s){s.setPage(e,r)}n.onPageChange.call(this,e,r,t)});if(n.triggerPageThreshold>0){a()}else if(e(n.next).attr("href")){var u=r.getCurrentScrollOffset(n.scrollContainer);E(function(){p(u)})}if(s&&s.havePage()){l();t=s.getPage();r.forceScrollTop(function(){var n;if(t>1){v(t);n=h(true);e("html, body").scrollTop(n)}else{a()}})}return o}function a(){c();n.scrollContainer.scroll(f)}function f(){var e,t;e=r.getCurrentScrollOffset(n.scrollContainer);t=h();if(e>=t){if(m()>=n.triggerPageThreshold){l();E(function(){p(e)})}else{p(e)}}n.onScroll(e,m(),t)}function l(){n.scrollContainer.unbind("scroll",f)}function c(){e(n.pagination).hide()}function h(t){var r,i;r=e(n.container).find(n.item).last();if(r.size()===0){return 0}i=r.offset().top+r.height();if(!t){i+=n.thresholdMargin}return i}function p(t,r){var s;s=e(n.next).attr("href");if(!s){if(n.noneleft){e(n.container).find(n.item).last().after(n.noneleft)}return l()}if(n.beforePageChange&&e.isFunction(n.beforePageChange)){if(n.beforePageChange(t,s)===false){return}}i.pushPages(t,s);l();y();d(s,function(t,i){var o=n.onLoadItems.call(this,i),u;if(o!==false){e(i).hide();u=e(n.container).find(n.item).last();u.after(i);e(i).fadeIn()}s=e(n.next,t).attr("href");e(n.pagination).replaceWith(e(n.pagination,t));b();c();if(s){a()}else{l()}n.onRenderComplete.call(this,i);if(r){r.call(this)}})}function d(t,r,i){var s=[],o,u=Date.now(),a,f;i=i||n.loaderDelay;e.get(t,null,function(t){o=e(n.container,t).eq(0);if(0===o.length){o=e(t).filter(n.container).eq(0)}if(o){o.find(n.item).each(function(){s.push(this)})}if(r){f=this;a=Date.now()-u;if(a<i){setTimeout(function(){r.call(f,t,s)},i-a)}else{r.call(f,t,s)}}},"html")}function v(t){var n=h(true);if(n>0){p(n,function(){l();if(i.getCurPageNum(n)+1<t){v(t);e("html,body").animate({scrollTop:n},400,"swing")}else{e("html,body").animate({scrollTop:n},1e3,"swing");a()}})}}function m(){var e=r.getCurrentScrollOffset(n.scrollContainer);return i.getCurPageNum(e)}function g(){var t=e(".expresscurate_loader");if(t.size()===0){t=e('<div class="expresscurate_loader">'+n.loader+"</div>");t.hide()}return t}function y(){var t=g(),r;if(n.customLoaderProc!==false){n.customLoaderProc(t)}else{r=e(n.container).find(n.item).last();r.after(t);t.fadeIn()}}function b(){var e=g();e.remove()}function w(t){var r=e(".expresscurate_trigger");if(r.size()===0){r=e('<div class="expresscurate_trigger"><a href="#">'+n.trigger+"</a></div>");r.hide()}e("a",r).unbind("click").bind("click",function(){S();t.call();return false});return r}function E(t){var r=w(t),i;if(n.customTriggerProc!==false){n.customTriggerProc(r)}else{i=e(n.container).find(n.item).last();i.after(r);r.fadeIn()}}function S(){var e=w();e.remove()}var n=e.extend({},e.expresscurate.defaults,t);var r=new e.expresscurate.util;var i=new e.expresscurate.paging(n.scrollContainer);var s=n.history?new e.expresscurate.history:false;var o=this;u()};e.expresscurate.defaults={container:"#container",scrollContainer:e(window),item:".item",pagination:"#pagination",next:".next",noneleft:false,loader:'<img src="images/loader.gif"/>',loaderDelay:600,triggerPageThreshold:3,trigger:"Load more items",thresholdMargin:0,history:true,onPageChange:function(){},beforePageChange:function(){},onLoadItems:function(){},onRenderComplete:function(){},onScroll:function(){},customLoaderProc:false,customTriggerProc:false};e.expresscurate.util=function(){function i(){e(window).load(function(){t=true})}var t=false;var n=false;var r=this;i();this.forceScrollTop=function(i){e("html,body").scrollTop(0);if(!n){if(!t){setTimeout(function(){r.forceScrollTop(i)},1)}else{i.call();n=true}}};this.getCurrentScrollOffset=function(e){var t,n;if(e.get(0)===window){t=e.scrollTop()}else{t=e.offset().top}n=e.height();return t+n}};e.expresscurate.paging=function(){function s(){e(window).scroll(o)}function o(){var t,s,o,f,l;t=i.getCurrentScrollOffset(e(window));s=u(t);o=a(t);if(r!==s||s===1&&r===1){f=o[0];l=o[1];n.call({},s,f,l)}}function u(e){for(var n=t.length-1;n>0;n--){if(e>t[n][0]){return n+1}}return 1}function a(e){for(var n=t.length-1;n>=0;n--){if(e>t[n][0]){return t[n]}}return null}var t=[[0,document.location.toString()]];var n=function(){};var r=1;var i=new e.expresscurate.util;s();this.getCurPageNum=function(t){t=t||i.getCurrentScrollOffset(e(window));return u(t)};this.onChangePage=function(e){n=e};this.pushPages=function(e,n){t.push([e,n])}};e.expresscurate.history=function(){function n(){t=!!(window.history&&history.pushState&&history.replaceState)}var e=false;var t=false;n();this.setPage=function(e,t){this.updateState({page:e},"",t)};this.havePage=function(){return this.getState()!==false};this.getPage=function(){var e;if(this.havePage()){e=this.getState();return e.page}return 1};this.getState=function(){var e,n,r;if(t){n=history.state;if(n&&n.expresscurate){return n.expresscurate}}else{e=window.location.href.substring(0,6)==="/page/";if(e){r=parseInt(window.location.href.replace("/page/",""),10);return{page:r}}}return false};this.updateState=function(t,n,r){if(e){this.replaceState(t,n,r)}else{this.pushState(t,n,r)}};this.pushState=function(n,r,i){var s;if(t){history.pushState({expresscurate:n},r,i)}else{s=n.page>0?"/page/"+n.page:"";history.pushState({expresscurate:n},r,i)}e=true};this.replaceState=function(e,n,r){if(t){history.replaceState({expresscurate:e},n,r)}else{this.pushState(e,n,r)}}}})(jQuery)